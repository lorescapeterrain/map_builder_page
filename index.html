<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lorescape Map Builder</title>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="dns-prefetch" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700&display=swap"
        rel="stylesheet">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style"
        crossorigin onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    </noscript>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
                "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/controls/OrbitControls.js",
                "three/examples/jsm/environments/RoomEnvironment.js": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/environments/RoomEnvironment.js",
                "three/examples/jsm/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/GLTFLoader.js"
            }
        }
    </script>
  <script type="module" crossorigin src="/assets/index-2ezQW1qJ.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/index-BHLLBBHy.css">
</head>

<body>
    <!-- Restart Confirmation Modal -->
    <div id="restart-modal" class="restart-modal hidden">
        <div class="restart-backdrop"></div>
        <div class="restart-content">
            <div class="restart-header">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Restart Application</h3>
            </div>
            <div class="restart-body">
                <p>Are you sure you want to restart the application?</p>
                <p><strong>All unsaved changes will be lost.</strong></p>
            </div>
            <div class="restart-footer">
                <button id="cancel-restart" class="btn-secondary">Cancel</button>
                <button id="confirm-restart" class="btn-danger">Restart</button>
            </div>
        </div>
    </div>

    <!-- Welcome Screen Modal -->
    <div id="welcome-modal" class="welcome-modal">
        <div class="welcome-backdrop"></div>
        <div class="welcome-content">
            <div class="welcome-header">
                <img src="assets/logo/lorescape-logo-light-mode.png" alt="Lorescape" class="welcome-logo" />
                <div class="welcome-titles">
                    <h1>Lorescape Map Builder</h1>
                    <div class="beta-badge">CLOSED BETA - BACKERS' EDITION</div>
                </div>
            </div>

            <div class="welcome-body">
                <div class="welcome-intro">
                    <h2>Welcome to the Lorescape Map Building tool!</h2>
                    <p>Lorescape Map Builder is an advanced tool for designing maps with hexagonal Lorescape tiles - a
                        modular terrain system for RPG, tactical, and board games.</p>
                </div>

                <div class="exclusive-access" id="password-gate">
                    <div class="kickstarter-info">
                        <i class="fas fa-info-circle"></i>
                        <div class="kickstarter-copy">
                            <h3>Closed Beta Access</h3>
                            <p>Thanks for backing Lorescape on Kickstarter!</p>
                            <p>Share your discoveries and feedback with the team so we can keep polishing the experience
                                before wide release.</p>
                            <form id="password-form" class="beta-password-form">
                                <label for="access-password" class="password-label">Access password</label>
                                <input type="password" id="access-password" name="access-password"
                                    class="password-input" placeholder="Enter password" autocomplete="current-password"
                                    required>
                                <p id="password-message" class="password-message" role="alert" aria-live="polite"></p>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="loading-section">
                    <div class="loading-info">
                        <h4>Loading application assets...</h4>
                        <p id="current-asset">Preparing environment...</p>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <div class="progress-stats">
                            <span id="progress-percentage">0%</span>
                            <span id="progress-details">0/0 assets</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="welcome-footer">
                <button id="start-building" class="start-button" disabled>
                    Start Building Maps
                </button>
            </div>
        </div>
    </div>

    <!-- Top Header -->
    <header class="top-header">
        <div class="header-content">
            <div class="logo-section">
                <img id="brand-logo" class="brand-logo" src="assets/logo/lorescape-logo-light-mode.png" alt="Lorescape"
                    width="36" height="36" />
                <div class="logo-text">
                    <h1><i class="fas fa-map"></i> Lorescape Map Builder</h1>
                    <span class="beta-indicator">CLOSED BETA - BACKERS' EDITION</span>
                </div>
            </div>
            <div class="map-name-spotlight" aria-label="Map name input">
                <label for="map-name-input-toolbar" class="map-name-label sr-only">Map Name</label>
                <div class="map-name-field">
                    <i class="fas fa-pen-nib" aria-hidden="true"></i>
                    <input type="text" id="map-name-input-toolbar" class="map-name-input-toolbar" value="Unnamed Map"
                        placeholder="Unnamed Map" maxlength="50" aria-label="Map name" aria-describedby="map-name-help">
                </div>
                <span id="map-name-help" class="sr-only">Used in file name when saving</span>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">TOTAL TILES</span>
                    <span class="stat-value" id="total-tiles">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">SETS USED</span>
                    <span class="stat-value" id="sets-used">0/0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">MAP SIZE</span>
                    <span class="stat-value" id="map-size">0x0</span>
                </div>
            </div>

            <!-- Integrated Toolbar -->
            <div class="integrated-toolbar">
                <!-- Map Management Group (buttons only) -->
                <div class="toolbar-group map-management-toolbar">
                    <button class="btn-toolbar btn-success" id="save-map-toolbar" type="button"
                        title="Save map to file">
                        <i class="fas fa-download"></i>
                        <span>Save</span>
                    </button>
                    <button class="btn-toolbar btn-info" id="load-map-toolbar" type="button" title="Load map from file">
                        <i class="fas fa-upload"></i>
                        <span>Load</span>
                    </button>
                    <button class="btn-toolbar btn-secondary" id="share-map-toolbar" type="button"
                        title="Share map via link">
                        <i class="fas fa-link"></i>
                        <span>Share</span>
                    </button>
                    <button class="btn-toolbar btn-danger" id="clear-map-toolbar" type="button"
                        title="Clear entire map (C)">
                        <i class="fas fa-trash"></i>
                        <span>Clear</span>
                    </button>
                    <input type="file" id="map-file-input-toolbar" accept=".json,.lsm" style="display: none;">
                </div>

                <!-- Action Group -->
                <div class="toolbar-group edit-history-toolbar">
                    <button class="btn-toolbar" id="undo-action-toolbar" disabled title="Undo last action (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                        <span>Undo</span>
                    </button>
                    <button class="btn-toolbar" id="redo-action-toolbar" disabled title="Redo last action (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                        <span>Redo</span>
                    </button>
                </div>
                <div class="toolbar-group export-toolbar">
                    <button class="btn-toolbar btn-primary" id="export-map-toolbar" title="Generate build instructions">
                        <i class="fas fa-layer-group"></i>
                        <span>Generate instructions</span>
                    </button>
                </div>

                <!-- Header Controls Group -->
                <div class="toolbar-group header-controls-toolbar">
                    <button class="btn-icon lighting-toggle" id="toggle-advanced-lighting" type="button"
                        title="Toggle Advanced Lighting" aria-label="Toggle advanced lighting">
                        <i class="fas fa-lightbulb"></i>
                    </button>
                    <button class="btn-icon theme-toggle" id="toggle-theme" title="Toggle Theme"
                        aria-label="Toggle theme">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    <span id="save-status" role="status" aria-live="polite" class="sr-only"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="main-layout">
        <!-- Left Panel -->
        <aside class="left-panel" id="left-panel">
            <div class="left-resize-handle" id="left-resize-handle" role="separator" aria-orientation="vertical"
                aria-label="Resize left panel"></div>
            <!-- Split Header arranged vertically -->
            <div class="split-header">
                <div class="panel-header-content">
                    <h2><i class="fas fa-layer-group"></i> Asset Library</h2>
                </div>

                <!-- Build Mode Controls -->
                <div class="build-mode-section">
                    <div class="build-mode-header">
                        <i class="fas fa-hammer"></i>
                        <span>Build Mode</span>
                    </div>
                    <div class="radio-group horizontal segmented" role="group" aria-label="Build mode options">
                        <label class="radio-option">
                            <input type="radio" name="buildMode" value="limited" checked
                                aria-label="Limited to owned sets">
                            <span class="seg-pill" tabindex="-1">
                                <i class="fas fa-lock option-icon" aria-hidden="true"></i>
                                <span class="option-text long">Limited to owned sets</span>
                                <span class="option-text short" aria-hidden="true">Limited</span>
                            </span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="buildMode" value="unlimited" aria-label="Unlimited mode">
                            <span class="seg-pill" tabindex="-1">
                                <i class="fas fa-infinity option-icon" aria-hidden="true"></i>
                                <span class="option-text long">Unlimited</span>
                                <span class="option-text short" aria-hidden="true">Unlimited</span>
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Library Toolbar -->
                <div class="library-toolbar">
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search packs, biomes..." id="search-input">
                        <button class="btn-icon btn-clear search-clear-btn" id="search-clear" title="Clear Search"
                            style="display: none;" type="button">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabbed Content (Packs & Biomes Only) -->
            <div class="tab-container">
                <div class="tab-header">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="packs">
                            <i class="fas fa-boxes"></i>
                            Environment Packs
                        </button>
                        <button class="tab-btn" data-tab="biomes">
                            <i class="fas fa-mountain"></i>
                            Biome Sets
                        </button>
                    </div>
                </div>
                <!-- Environment Packs Tab -->
                <div class="tab-content active" id="tab-packs">
                    <div class="asset-section" id="packs-grid">
                        <!-- Environment pack cards will be inserted here -->
                    </div>
                </div>

                <!-- Biome Sets Tab -->
                <div class="tab-content" id="tab-biomes">
                    <div class="asset-section" id="biomes-grid">
                        <!-- Biome set cards will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Permanent Tile Selection Section -->
            <div class="tile-selection-section">
                <div class="section-header" id="tile-selection-header">
                    <div class="section-header-main">
                        <i class="fas fa-th"></i>
                        <span>Tile Selection</span>
                    </div>
                    <div class="tile-selection-summary" id="tile-selection-summary" aria-live="polite"></div>
                </div>
                <div class="tile-browser">
                    <div class="biome-selector">
                        <div class="tile-filter-bar">
                            <select id="tile-source-filter" class="tile-filter-select"
                                aria-label="Filter biomes by source">
                                <option value="all">All sources</option>
                                <option value="packs">Environment packs only</option>
                                <option value="standalone">Standalone only</option>
                            </select>
                            <input type="text" id="tile-search-input" class="tile-filter-search"
                                placeholder="Search biomes..." aria-label="Search available biomes">
                        </div>
                        <select id="biome-select" class="biome-select">
                            <option value="">Select a biome to view tiles</option>
                        </select>
                    </div>
                    <div class="tile-grid-container" id="tile-grid-container">
                        <div class="tile-grid-wrapper" id="tile-grid-wrapper">
                            <div class="tile-grid" id="tile-grid">
                                <!-- 50-slot tile grid will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map Canvas -->
        <section class="map-section">
            <div class="map-container" id="map-container">
                <!-- 3D map will be rendered here -->
            </div>

            <!-- Map Controls Overlay -->
            <div class="map-overlay">
                <div class="overlay-control-stack is-collapsed" id="overlay-control-stack" data-expanded="false">
                    <div class="control-stack-collapsed" id="overlay-control-collapsed" aria-hidden="false">
                        <button class="control-pill control-pill-unified" type="button" data-section="camera"
                            aria-expanded="false" aria-controls="overlay-control-expanded"
                            title="Open camera and view controls">
                            <i class="fas fa-video"></i>
                            <span>Camera | View</span>
                        </button>
                    </div>
                    <div class="control-stack-expanded" id="overlay-control-expanded" aria-hidden="true" role="group"
                        aria-label="Camera and view controls">
                        <div class="control-stack-header">
                            <span class="control-stack-title"><i class="fas fa-video"></i> Camera | View</span>
                            <button class="control-stack-collapse" type="button" id="overlay-control-collapse"
                                aria-label="Collapse camera and view controls">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="control-stack-body">
                            <div class="camera-toolbar" id="camera-toolbar" role="group" aria-label="Camera presets">
                                <div class="camera-toolbar__header">
                                    <i class="fas fa-video"></i>
                                    <span>Camera</span>
                                </div>
                                <div class="camera-buttons camera-buttons--grid" role="presentation">
                                    <button class="camera-btn camera-btn--primary" type="button"
                                        data-camera-preset="default" title="Auto-fit view centered on the map (1)"
                                        aria-keyshortcuts="1" data-shortcut="1">
                                        <i class="fas fa-cube"></i>
                                        <span class="camera-label">Default</span>
                                    </button>
                                    <button class="camera-btn" type="button" data-camera-preset="top"
                                        title="Top-down overview (2)" aria-keyshortcuts="2" data-shortcut="2">
                                        <i class="fas fa-arrow-up-long"></i>
                                        <span class="camera-label">Top</span>
                                    </button>
                                    <button class="camera-btn" type="button" data-camera-preset="front"
                                        title="Front view (click twice to flip) (3)" aria-keyshortcuts="3"
                                        data-shortcut="3">
                                        <i class="fas fa-arrows-up-down"></i>
                                        <span class="camera-label">Front</span>
                                    </button>
                                    <button class="camera-btn" type="button" data-camera-preset="side"
                                        title="Side view (click twice to flip) (4)" aria-keyshortcuts="4"
                                        data-shortcut="4">
                                        <i class="fas fa-arrows-left-right"></i>
                                        <span class="camera-label">Side</span>
                                    </button>
                                    <button class="camera-btn" type="button" data-camera-preset="isometric"
                                        title="Isometric showcase angle (5)" aria-keyshortcuts="5" data-shortcut="5">
                                        <i class="fas fa-dice-d20"></i>
                                        <span class="camera-label">Isometric</span>
                                    </button>
                                </div>
                                <button class="camera-btn camera-btn--first-person" type="button"
                                    data-camera-preset="first-person" title="First-person exploration with WASD (F)"
                                    aria-keyshortcuts="F" data-shortcut="F">
                                    <i class="fas fa-person-running"></i>
                                    <span class="camera-label">First-person</span>
                                </button>
                                <p class="camera-hint hidden" id="first-person-hint">
                                    WASD: move • Space / Ctrl: up / down • Shift: sprint • ESC: exit
                                </p>
                            </div>
                            <div class="view-toolbar" id="view-toolbar" role="group" aria-label="Layer view controls">
                                <div class="view-toolbar__header">
                                    <i class="fas fa-layer-group"></i>
                                    <span>View</span>
                                </div>
                                <div class="view-toolbar__controls" role="presentation">
                                    <button class="view-btn" type="button" data-layer-action="down"
                                        title="Show previous layer (Q)" aria-keyshortcuts="Q" data-shortcut="Q">
                                        <i class="fas fa-chevron-down"></i>
                                        <span class="view-label">Layer down</span>
                                    </button>
                                    <div class="view-status" id="view-status" aria-live="polite">All layers</div>
                                    <button class="view-btn" type="button" data-layer-action="up"
                                        title="Show next layer (E)" aria-keyshortcuts="E" data-shortcut="E">
                                        <i class="fas fa-chevron-up"></i>
                                        <span class="view-label">Layer up</span>
                                    </button>
                                </div>
                                <button class="view-btn view-btn--full" type="button" data-layer-action="all"
                                    title="Show all layers (A)" aria-keyshortcuts="A" data-shortcut="A">
                                    <i class="fas fa-globe"></i>
                                    <span class="view-label">Full map</span>
                                </button>
                                <button class="view-btn view-btn--capture" type="button" id="view-capture-btn"
                                    title="Save current 3D view (P)" aria-keyshortcuts="P" data-shortcut="P">
                                    <i class="fas fa-camera"></i>
                                    <span class="view-label">Capture view</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Temporary: Ghost opacity controls -->
                <div class="ghost-opacity-controls hidden" id="ghost-opacity-controls" aria-live="polite">
                    <div class="ghost-controls-title"><i class="fas fa-eye"></i> Ghost opacity (temp)</div>
                    <label class="ghost-slider">
                        <span>Top</span>
                        <input id="ghost-top-opacity" type="range" min="0" max="1" step="0.01" value="0.75"
                            aria-label="Ghost top opacity">
                        <span class="ghost-value" id="ghost-top-opacity-value">0.75</span>
                    </label>
                    <label class="ghost-slider">
                        <span>Sides</span>
                        <input id="ghost-side-opacity" type="range" min="0" max="1" step="0.01" value="0.50"
                            aria-label="Ghost side opacity">
                        <span class="ghost-value" id="ghost-side-opacity-value">0.50</span>
                    </label>
                </div>
                <div class="level-indicator" id="level-indicator">
                    Level: 1
                </div>
                <div class="controls-hint" id="controls-hint">
                    <div class="hint-long">
                        <strong>Controls:</strong> Click: Place | RMB: Remove | R: Rotate | C: Clear | Page Up/Down:
                        Height<br>
                        <strong>Camera:</strong> 1-5 presets • F: First-person • L-Drag: Orbit • RMB-Drag: Pan • Wheel:
                        Zoom<br>
                        <strong>View:</strong> Q: Layer ↓ | E: Layer ↑ | A: Full map | P: Capture view
                    </div>
                    <div class="hint-short" aria-hidden="true">
                        <strong>Controls:</strong> Click=Place • RMB=Remove • R=Rotate • C=Clear • PgUp/Down=Height<br>
                        <strong>Camera:</strong> 1-5 presets • F=FP • L-Drag=Orbit • R-Drag=Pan • Wheel=Zoom<br>
                        <strong>View:</strong> Q=Layer↓ • E=Layer↑ • A=Full • P=Capture
                    </div>
                </div>
            </div>
        </section>

        <!-- Right Panel -->
        <aside class="right-panel" id="right-panel">
            <div class="panel-header">
                <h2><i class="fas fa-chart-pie"></i> Map Analytics</h2>
            </div>
            <div class="right-resize-handle" id="right-resize-handle" role="separator" aria-orientation="vertical"
                aria-label="Resize right panel"></div>

            <!-- Statistics Panels -->
            <div class="stats-container">
                <!-- Overview Panel -->
                <div class="stats-panel stats-panel--summary">
                    <div class="panel-title">
                        <i class="fas fa-info-circle"></i>
                        Build summary
                    </div>
                    <div class="stats-grid map-stats" id="map-stats">
                        <div class="stat-box">
                            <div class="stat-number" id="total-placed">0</div>
                            <div class="stat-label">Total Tiles</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="unique-biomes">0</div>
                            <div class="stat-label">Biome Sets</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="height-levels">0</div>
                            <div class="stat-label">Height Levels</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="sets-required">0</div>
                            <div class="stat-label">Packs Required</div>
                        </div>
                    </div>
                </div>

                <!-- Biome Breakdown Panel -->
                <div class="stats-panel stats-panel--composition">
                    <div class="panel-title">
                        <i class="fas fa-layer-group"></i>
                        Composition breakdown
                    </div>
                    <div class="biome-breakdown" id="biome-breakdown">
                        <div class="empty-state">No tiles placed yet</div>
                    </div>
                </div>

                <!-- Efficiency Metrics Panel -->
                <div class="stats-panel stats-panel--resource">
                    <div class="panel-title">
                        <i class="fas fa-chart-line"></i>
                        Resource planning
                    </div>
                    <div class="efficiency-metrics" id="efficiency-metrics">
                        <div class="empty-state">No tiles placed yet</div>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- JavaScript -->
    <!-- Edge toggles to reopen collapsed panels -->
    <button class="edge-toggle edge-left" id="edge-toggle-left" title="Toggle left panel"
        aria-label="Toggle left panel">
        <i class="fas fa-chevron-right"></i>
    </button>
    <button class="edge-toggle edge-right" id="edge-toggle-right" title="Toggle right panel"
        aria-label="Toggle right panel">
        <i class="fas fa-chevron-left"></i>
    </button>

    <!-- Debug viewport widget (toggle: Ctrl+Alt+D) -->
    <div id="debug-viewport" class="debug-viewport hidden" aria-hidden="true"></div>

    <!-- Custom notification system -->
    <div id="notification-container" class="notification-container" aria-live="polite" aria-atomic="true"></div>

    <!-- Share success modal -->
    <div id="share-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content share-modal">
            <div class="modal-header">
                <i class="fas fa-check-circle modal-icon success"></i>
                <h3 class="modal-title">Map Shared Successfully!</h3>
                <button class="modal-close" id="share-modal-close" type="button" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-message">Your map has been shared and the link is ready to use.</p>
                <div class="share-link-container">
                    <input type="text" id="share-link-input" class="share-link-input" readonly>
                    <button class="btn-copy" id="copy-link-btn" type="button" title="Copy to clipboard">
                        <i class="fas fa-copy"></i>
                        <span>Copy</span>
                    </button>
                </div>
                <div class="share-id-container" id="share-id-row" hidden>
                    <label for="share-id-input" class="share-id-label">Map ID</label>
                    <input type="text" id="share-id-input" class="share-id-input" readonly>
                    <p class="share-id-hint">Share this ID with mobile viewers to load the same map without the full
                        link.</p>
                </div>
                <p class="modal-hint">
                    <i class="fas fa-info-circle"></i>
                    Share this link with others to let them view your map
                </p>
            </div>
        </div>
    </div>

    <div id="mobile-viewer-shell" class="mobile-viewer-shell hidden" aria-live="polite">
        <div class="mobile-viewer-header">
            <div class="mobile-viewer-icon" aria-hidden="true"><i class="fas fa-mobile-screen"></i></div>
            <div class="mobile-viewer-copy">
                <h2>Mobile Viewer</h2>
                <p>Editing is available on desktop. This simplified viewer lets you load and explore maps on the go.</p>
            </div>
            <button id="mobile-theme-toggle" class="mobile-theme-toggle" type="button" aria-label="Toggle theme">
                <i class="fas fa-sun"></i>
            </button>
        </div>
        <div class="mobile-viewer-actions">
            <button id="mobile-load-file-btn" class="mobile-action primary" type="button">
                <i class="fas fa-folder-open"></i>
                <span>Load From Device</span>
            </button>
            <div class="mobile-collapsible" data-mobile-section="load-id">
                <button id="mobile-load-id-toggle" class="mobile-action mobile-action--collapsible" type="button">
                    <i class="fas fa-key"></i>
                    <span>Load With ID</span>
                </button>
                <div class="mobile-panel mobile-collapsible-panel" id="mobile-load-id-panel" hidden>
                    <form id="mobile-load-id-form">
                        <label for="mobile-share-id-input">Enter map ID</label>
                        <div class="mobile-input-row">
                            <input type="text" id="mobile-share-id-input" name="shareId" placeholder="e.g. fiXQ0V_x"
                                maxlength="60" required>
                            <button type="submit" class="mobile-submit-btn">
                                <i class="fas fa-cloud-arrow-down"></i>
                                <span>Load</span>
                            </button>
                        </div>
                        <p class="mobile-helper-text">The ID is the part after ?share= in the desktop share link.</p>
                    </form>
                </div>
            </div>
            <button id="mobile-clear-map-btn" class="mobile-action" type="button">
                <i class="fas fa-trash"></i>
                <span>Clear Map</span>
            </button>
        </div>

        <div class="mobile-panel mobile-view-panel" id="mobile-view-panel" aria-live="polite">
            <div class="mobile-view-header">
                <div class="mobile-view-header-title">
                    <i class="fas fa-layer-group" aria-hidden="true"></i>
                    <span>View Layers</span>
                </div>
                <span id="mobile-view-status" class="mobile-view-status" role="status" aria-live="polite">All
                    layers</span>
            </div>
            <div class="mobile-view-row" role="group" aria-label="Layer navigation">
                <button id="mobile-layer-down" class="mobile-view-btn mobile-view-btn--secondary" type="button">
                    <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    <span>Layer down</span>
                </button>
                <button id="mobile-layer-up" class="mobile-view-btn mobile-view-btn--primary" type="button">
                    <i class="fas fa-chevron-up" aria-hidden="true"></i>
                    <span>Layer up</span>
                </button>
            </div>
            <button id="mobile-layer-reset" class="mobile-view-btn mobile-view-btn--full" type="button">
                <i class="fas fa-globe" aria-hidden="true"></i>
                <span>Full map</span>
            </button>
        </div>
        <div class="mobile-collapsible" data-mobile-section="analytics">
            <button id="mobile-analytics-toggle" class="mobile-action mobile-action--collapsible" type="button">
                <i class="fas fa-chart-pie"></i>
                <span>Analytics</span>
            </button>
            <div class="mobile-panel mobile-collapsible-panel" id="mobile-analytics-panel" hidden>
                <div class="mobile-analytics-summary" id="mobile-analytics-summary"></div>
                <div class="mobile-analytics-sets" id="mobile-analytics-sets"></div>
            </div>
        </div>
        <input type="file" id="mobile-map-file-input" accept=".json,.lsm" hidden>
    </div>

    <script>
        (function () {
            const root = document.body;
            const header = document.querySelector('.top-header');
            const btn = document.getElementById('toggle-theme');
            const icon = document.getElementById('theme-icon');
            const brandLogo = document.getElementById('brand-logo');
            const saved = localStorage.getItem('ls_theme');
            const initial = saved || 'light';
            if (initial === 'dark') {
                root.setAttribute('data-theme', 'dark');
                icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                if (brandLogo) brandLogo.src = 'assets/logo/lorescape-logo-dark-mode.png';
            } else {
                root.removeAttribute('data-theme');
                if (brandLogo) brandLogo.src = 'assets/logo/lorescape-logo-light-mode.png';
            }
            const main = document.querySelector('.main-layout');
            function onScroll() {
                if (!header) return;
                const scrolled = (main?.scrollTop || window.scrollY) > 0;
                header.classList.toggle('scrolled', !!scrolled);
            }
            main?.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('scroll', onScroll, { passive: true });
            onScroll();
            // Keep main area exactly within viewport height by measuring header
            function setHeaderHeightVar() {
                const h = header?.offsetHeight || 100;
                document.documentElement.style.setProperty('--header-h', h + 'px');
            }
            setHeaderHeightVar();
            window.addEventListener('resize', setHeaderHeightVar);
            // Debug: viewport/breakpoint overlay
            const dbg = document.getElementById('debug-viewport');
            const leftPanel = document.getElementById('left-panel');
            const rightPanel = document.getElementById('right-panel');
            function currentBreakpoint(w) {
                if (w <= 760) return '≤760';
                if (w <= 900) return '≤900';
                if (w <= 1200) return '≤1200';
                return '>1200';
            }
            function renderDebug() {
                if (!dbg || dbg.classList.contains('hidden')) return;
                const w = Math.round(window.innerWidth);
                const h = Math.round(window.innerHeight);
                const lp = leftPanel ? leftPanel.getBoundingClientRect().width : 0;
                const rp = rightPanel ? rightPanel.getBoundingClientRect().width : 0;
                const main = document.querySelector('.main-layout');
                const mh = main ? Math.round(main.getBoundingClientRect().height) : 0;
                dbg.innerHTML = `
                                            <div class="line">VW×VH: ${w}×${h} <span class="muted">(bp ${currentBreakpoint(w)})</span></div>
                                            <div class="line">Main H: ${mh}px; Header H: ${header?.offsetHeight || 0}px</div>
                                            <div class="line">Left: ${Math.round(lp)}px | Right: ${Math.round(rp)}px</div>
                                        `;
            }
            const rerender = () => { setHeaderHeightVar(); renderDebug(); };
            window.addEventListener('resize', rerender);
            window.addEventListener('orientationchange', rerender);
            // Toggle with Ctrl+Alt+D
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.altKey && (e.key === 'd' || e.key === 'D')) {
                    dbg?.classList.toggle('hidden');
                    renderDebug();
                }
            });
            // initial, keep hidden until toggled
            btn?.addEventListener('click', () => {
                const isDark = root.getAttribute('data-theme') === 'dark';
                if (isDark) {
                    root.removeAttribute('data-theme');
                    icon.classList.remove('fa-sun'); icon.classList.add('fa-moon');
                    localStorage.setItem('ls_theme', 'light');
                    if (brandLogo) brandLogo.src = 'assets/logo/lorescape-logo-light-mode.png';
                } else {
                    root.setAttribute('data-theme', 'dark');
                    icon.classList.remove('fa-moon'); icon.classList.add('fa-sun');
                    localStorage.setItem('ls_theme', 'dark');
                    if (brandLogo) brandLogo.src = 'assets/logo/lorescape-logo-dark-mode.png';
                }
            });
        })();
    </script>
</body>

</html>